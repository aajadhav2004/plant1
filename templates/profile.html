<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile | Medicinal Plant Identification</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>

<body>
    {% include 'includes/header.html' %}
    <style>
        .profile-container {
            max-width: 1000px;
            margin: 80px auto 0;
            padding: 20px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-header h1 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .profile-header p {
            color: #555;
            font-size: 18px;
        }

        .profile-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .profile-sidebar {
            flex: 1;
            min-width: 300px;
        }

        .profile-details {
            flex: 2;
            min-width: 300px;
        }

        .profile-photo-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-photo {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 20px;
            border: 5px solid #2e7d32;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-photo-placeholder {
            color: #999;
            font-size: 80px;
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            margin-top: 10px;
        }

        .upload-btn {
            border: 2px solid #2e7d32;
            color: #2e7d32;
            background-color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background-color: #2e7d32;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(46, 125, 50, 0.2);
        }

        .upload-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2);
        }

        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }

        .info-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .info-card h2 {
            color: #2e7d32;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .info-row {
            display: flex;
            margin-bottom: 15px;
            align-items: center;
        }

        .info-label {
            font-weight: bold;
            width: 120px;
            color: #555;
        }

        .info-value {
            flex: 1;
        }

        .edit-btn {
            background-color: #2e7d32;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .edit-btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .edit-btn:hover {
            background-color: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(27, 94, 32, 0.2);
        }

        .edit-btn:hover:before {
            width: 300px;
            height: 300px;
        }

        .edit-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(27, 94, 32, 0.2);
        }

        .activity-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .activity-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-date {
            color: #777;
            font-size: 0.9em;
        }

        .edit-profile-form {
            display: none;
        }

        .edit-profile-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .cancel-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .cancel-btn:hover {
            background-color: #d32f2f;
        }

        .save-btn {
            background-color: #2e7d32;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 120px;
        }

        .save-btn:hover:not(:disabled) {
            background-color: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(27, 94, 32, 0.2);
        }

        .save-btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(27, 94, 32, 0.2);
        }

        .save-btn:disabled {
            background-color: #90a492;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        .save-btn:disabled {
            animation: fadeInOut 1.5s infinite;
        }

        /* Add ripple effect animation */
        @keyframes ripple {
            from {
                opacity: 1;
                transform: scale(0);
            }

            to {
                opacity: 0;
                transform: scale(4);
            }
        }

        /* Add click animation class */
        .button-click {
            animation: pulse 0.3s ease;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(0.95);
            }

            100% {
                transform: scale(1);
            }
        }

        @media (max-width: 768px) {
            .profile-content {
                flex-direction: column;
            }

            .profile-sidebar,
            .profile-details {
                width: 100%;
            }
        }
    </style>
    </head>

    <body>
        <nav class="navbar">
            <div class="logo">
                <img src="{{ url_for('static', filename='css/leaf-icon.svg') }}" alt="Leaf Icon">
                <h1>Medicinal Plant Identifier</h1>
            </div>
            <div class="nav-links">
                <a href="{{ url_for('home') }}" class="nav-link">Home</a>
                <a href="{{ url_for('index') }}" class="nav-link">Identify</a>
                <a href="{{ url_for('performance') }}" class="nav-link">Performance</a>
                <a href="{{ url_for('profile') }}" class="nav-link active">Profile</a>
                <button id="logout-btn" class="btn logout-btn">Logout</button>
            </div>
        </nav>

        <div class="profile-container">
            <div class="profile-header">
                <h1>User Profile</h1>
                <p>Manage your account information and preferences</p>
            </div>

            <div class="profile-content">
                <div class="profile-sidebar">
                    <div class="profile-photo-container">
                        <div class="profile-photo" id="profile-photo">
                            <div class="profile-photo-placeholder" id="photo-placeholder">👤</div>
                            <img id="user-photo" style="display: none;" alt="User Photo">
                        </div>
                        <h3 id="user-name">{{ session['user']['displayName'] if session['user'].get('displayName') else
                            'User' }}</h3>
                        <div class="upload-btn-wrapper">
                            <button class="upload-btn">Upload Photo</button>
                            <input type="file" id="photo-upload" accept="image/*" />
                        </div>
                    </div>

                    <div class="info-card">
                        <h2>Account Summary</h2>
                        <div class="info-row">
                            <div class="info-label">Member Since:</div>
                            <div class="info-value" id="member-since">{{ user_data.createdAt if
                                user_data.get('createdAt')
                                else session['user'].get('createdAt', 'N/A') }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Last Login:</div>
                            <div class="info-value" id="last-login">{{ user_data.lastLoginAt if
                                user_data.get('lastLoginAt')
                                else session['user'].get('lastLoginAt', 'N/A') }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Plants Identified:</div>
                            <div class="info-value" id="plants-identified">{{ user_data.plantsIdentified if
                                user_data.get('plantsIdentified') else '0' }}</div>
                        </div>
                    </div>
                </div>

                <div class="profile-details">
                    <div class="info-card" id="profile-info">
                        <h2>Personal Information</h2>
                        <div class="info-row">
                            <div class="info-label">Name:</div>
                            <div class="info-value" id="display-name">{{ user_data.displayName if
                                user_data.get('displayName') else 'Not set' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Email:</div>
                            <div class="info-value" id="email">{{ session['user']['email'] if
                                session['user'].get('email')
                                else 'Not set' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Phone:</div>
                            <div class="info-value" id="phone">{{ user_data.phoneNumber if user_data.get('phoneNumber')
                                else
                                'Not set' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Location:</div>
                            <div class="info-value" id="location">{{ user_data.location if user_data.get('location')
                                else
                                'Not set' }}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Bio:</div>
                            <div class="info-value" id="bio">{{ user_data.bio if user_data.get('bio') else 'Not set' }}
                            </div>
                        </div>
                        <button class="edit-btn" id="edit-profile-btn">Edit Profile</button>
                    </div>

                    <div class="edit-profile-form info-card" id="edit-profile-form">
                        <h2>Edit Profile</h2>
                        <div class="form-group">
                            <label for="edit-name">Name:</label>
                            <input type="text" id="edit-name"
                                value="{{ user_data.displayName if user_data.get('displayName') else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="edit-email">Email:</label>
                            <input type="email" id="edit-email"
                                value="{{ session['user']['email'] if session['user'].get('email') else '' }}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="edit-phone">Phone:</label>
                            <input type="tel" id="edit-phone"
                                value="{{ user_data.phoneNumber if user_data.get('phoneNumber') else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="edit-location">Location:</label>
                            <input type="text" id="edit-location"
                                value="{{ user_data.location if user_data.get('location') else '' }}">
                        </div>
                        <div class="form-group">
                            <label for="edit-bio">Bio:</label>
                            <input type="text" id="edit-bio"
                                value="{{ user_data.bio if user_data.get('bio') else '' }}">
                        </div>
                        <div class="form-actions">
                            <button class="cancel-btn" id="cancel-edit-btn">Cancel</button>
                            <button class="save-btn" id="save-profile-btn">Save Changes</button>
                        </div>
                    </div>

                    <div class="activity-card">
                        <h2>Recent Activity</h2>
                        {% if recent_activity and recent_activity|length > 0 %}
                        {% for activity in recent_activity %}
                        <div class="activity-item">
                            <div>{{ activity.action }} <strong>{{ activity.plant }}</strong></div>
                            <div class="activity-date">{{ activity.display_time }}</div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="activity-item">
                            <div>No plant identifications yet. Start by identifying a plant!</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Function to add click animation
            function addClickEffect(element) {
                element.classList.add('button-click');
                setTimeout(() => {
                    element.classList.remove('button-click');
                }, 300);
            }

            // Add click effect to all buttons
            document.querySelectorAll('.edit-btn, .upload-btn, .save-btn, .cancel-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    addClickEffect(this);
                });
            });

            // Profile photo upload functionality
            document.getElementById('photo-upload').addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    // Create FormData and upload immediately
                    const formData = new FormData();
                    formData.append('photo', file);

                    fetch('/upload_profile_photo', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                const userPhoto = document.getElementById('user-photo');
                                // Use createObjectURL for immediate display
                                userPhoto.src = URL.createObjectURL(file);
                                userPhoto.style.display = 'block';
                                document.getElementById('photo-placeholder').style.display = 'none';
                            } else {
                                console.error('Failed to upload photo:', data.message);
                                alert('Failed to upload photo. Please try again.');
                            }
                        })
                        .catch(error => {
                            console.error('Error uploading photo:', error);
                            alert('Error uploading photo. Please try again.');
                        });
                }
            });

            // Edit profile functionality
            document.getElementById('edit-profile-btn').addEventListener('click', function () {
                document.getElementById('profile-info').style.display = 'none';
                document.getElementById('edit-profile-form').classList.add('active');
            });

            document.getElementById('cancel-edit-btn').addEventListener('click', function () {
                document.getElementById('profile-info').style.display = 'block';
                document.getElementById('edit-profile-form').classList.remove('active');
                // Reset form to original values
                loadUserProfile();
            });

            document.getElementById('save-profile-btn').addEventListener('click', function () {
                // Get form values
                const name = document.getElementById('edit-name').value;
                const phone = document.getElementById('edit-phone').value;
                const location = document.getElementById('edit-location').value;
                const bio = document.getElementById('edit-bio').value;

                // Update profile on server
                updateUserProfile({
                    displayName: name,
                    phoneNumber: phone,
                    location: location,
                    bio: bio
                });
            });

            // Show loading state
            function showLoadingState() {
                const saveBtn = document.getElementById('save-profile-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
            }

            // Hide loading state
            function hideLoadingState() {
                const saveBtn = document.getElementById('save-profile-btn');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }

            // Update UI elements with new profile data
            function updateUIElements(data) {
                // Update display values
                document.getElementById('display-name').textContent = data.displayName || 'Not set';
                document.getElementById('user-name').textContent = data.displayName || 'User';
                document.getElementById('phone').textContent = data.phoneNumber || 'Not set';
                document.getElementById('location').textContent = data.location || 'Not set';
                document.getElementById('bio').textContent = data.bio || 'Not set';

                // Hide edit form
                document.getElementById('profile-info').style.display = 'block';
                document.getElementById('edit-profile-form').classList.remove('active');

                // Show success message
                const successMessage = document.createElement('div');
                successMessage.textContent = 'Profile updated successfully!';
                successMessage.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 4px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                z-index: 1000;
                opacity: 0;
                transform: translateY(-20px);
                transition: opacity 0.3s, transform 0.3s;
            `;
                document.body.appendChild(successMessage);

                // Show and then hide the success message
                setTimeout(() => {
                    successMessage.style.opacity = '1';
                    successMessage.style.transform = 'translateY(0)';
                }, 100);

                setTimeout(() => {
                    successMessage.style.opacity = '0';
                    successMessage.style.transform = 'translateY(-20px)';
                    setTimeout(() => successMessage.remove(), 300);
                }, 3000);
            }

            // Function to update user profile on server
            function updateUserProfile(profileData) {
                showLoadingState();

                fetch('/update_profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(profileData)
                })
                    .then(response => response.json())
                    .then(data => {
                        hideLoadingState();
                        if (data.status === 'success') {
                            // Update UI elements with new data
                            document.getElementById('display-name').textContent = data.data.displayName || 'Not set';
                            document.getElementById('user-name').textContent = data.data.displayName || 'User';
                            document.getElementById('phone').textContent = data.data.phoneNumber || 'Not set';
                            document.getElementById('location').textContent = data.data.location || 'Not set';
                            document.getElementById('bio').textContent = data.data.bio || 'Not set';

                            // Hide edit form and show display view
                            document.getElementById('profile-info').style.display = 'block';
                            document.getElementById('edit-profile-form').classList.remove('active');

                            // Show success message
                            const successMessage = document.createElement('div');
                            successMessage.textContent = 'Profile updated successfully!';
                            successMessage.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background-color: #4CAF50;
                            color: white;
                            padding: 15px 20px;
                            border-radius: 4px;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                            z-index: 1000;
                            opacity: 0;
                            transform: translateY(-20px);
                            transition: opacity 0.3s, transform 0.3s;
                        `;
                            document.body.appendChild(successMessage);

                            // Show and then hide the success message
                            setTimeout(() => {
                                successMessage.style.opacity = '1';
                                successMessage.style.transform = 'translateY(0)';
                            }, 100);

                            setTimeout(() => {
                                successMessage.style.opacity = '0';
                                successMessage.style.transform = 'translateY(-20px)';
                                setTimeout(() => successMessage.remove(), 300);
                            }, 3000);
                        } else {
                            alert('Failed to update profile. Please try again.');
                        }
                    })
                    .catch(error => {
                        hideLoadingState();
                        console.error('Error updating profile:', error);
                        alert('Error updating profile. Please try again.');
                    });
            }

            // Load and apply initial profile data
            function initializeProfile(userData) {
                // Update form fields
                document.getElementById('edit-name').value = userData.displayName || '';
                document.getElementById('edit-phone').value = userData.phoneNumber || '';
                document.getElementById('edit-location').value = userData.location || '';
                document.getElementById('edit-bio').value = userData.bio || '';

                // Update display fields
                document.getElementById('display-name').textContent = userData.displayName || 'Not set';
                document.getElementById('user-name').textContent = userData.displayName || 'User';
                document.getElementById('phone').textContent = userData.phoneNumber || 'Not set';
                document.getElementById('location').textContent = userData.location || 'Not set';
                document.getElementById('bio').textContent = userData.bio || 'Not set';

                // Handle profile photo
                const userPhoto = document.getElementById('user-photo');
                const photoPlaceholder = document.getElementById('photo-placeholder');
                if (userData.photoURL) {
                    userPhoto.src = userData.photoURL;
                    userPhoto.style.display = 'block';
                    photoPlaceholder.style.display = 'none';
                } else {
                    userPhoto.style.display = 'none';
                    photoPlaceholder.style.display = 'block';
                }
            }

            // Initialize with data from server
            const initialUserData = {
                displayName: "{{ user_data.displayName if user_data else '' }}",
                phoneNumber: "{{ user_data.phoneNumber if user_data else '' }}",
                location: "{{ user_data.location if user_data else '' }}",
                bio: "{{ user_data.bio if user_data else '' }}",
                photoURL: "{{ user_data.photoURL if user_data and user_data.get('photoURL') else '' }}"
            };

            initializeProfile(initialUserData);

            // Function to upload profile photo to server
            function uploadProfilePhoto(file) {
                // Create FormData object
                const formData = new FormData();
                formData.append('photo', file);

                // Send to server
                fetch('/upload_profile_photo', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Photo uploaded successfully:', data);
                        if (data.photoURL) {
                            const userPhoto = document.getElementById('user-photo');
                            const photoPlaceholder = document.getElementById('photo-placeholder');
                            userPhoto.src = data.photoURL;
                            userPhoto.style.display = 'block';
                            photoPlaceholder.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error uploading photo:', error);
                    });
            }

            // Initialize Firebase and add logout functionality
            document.addEventListener('DOMContentLoaded', function () {
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', window.signOutUser);
                }

                // Initialize profile photo display
                const userPhoto = document.getElementById('user-photo');
                const photoPlaceholder = document.getElementById('photo-placeholder');

                if (initialUserData.photoURL) {
                    userPhoto.src = initialUserData.photoURL;
                    userPhoto.style.display = 'block';
                    photoPlaceholder.style.display = 'none';
                } else {
                    userPhoto.style.display = 'none';
                    photoPlaceholder.style.display = 'block';
                }
            });

            // Initialize
            checkProfilePhoto();
        </script>

        <!-- Load Firebase configuration and handlers -->
        <script src="{{ url_for('static', filename='js/firebase.js') }}"></script>
        <script>
            // Initialize Firebase and add logout functionality
            document.addEventListener('DOMContentLoaded', function () {
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', window.signOutUser);
                }
            });
        </script>
    </body>

</html>